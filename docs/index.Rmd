```
---
title: "Vansoh"
date: "2025-10-28"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Load libraries
library("vroom")
library("tidyverse")
library("ggplot2")
library("knitr")
library("dplyr")
library("lubridate")
library("janitor")

```

Introduction

This report examines monthly prescribing of antihistamines across NHS Scotland Health Boards. The objective is to identify whether prescribing demonstrates seasonal variation, and whether the magnitude of prescribing differs across Boards.

Data were supplied as multiple prescribing extracts, each containing prescription items, quantities , costs and metadata including Heath board (HBT) and Paid Date Month

Data Preparation
```{r}

# Read CSVs from URL
jul_aug_2025 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f02161c1-15f6-4d9f-8be5-01ba613d4303/download/hb_pitc2025_07.csv") %>% 
clean_names()

jan_jun_2025 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9de908b3-9c28-4cc3-aa32-72350a0579d1/download/hb_pitc2025_01_06.csv") %>% 
clean_names()

jan_jun_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f0df380b-3f9b-4536-bb87-569e189b727a/download/hb_pitc2024_01_06-1.csv") %>% 
clean_names()

jul_dec_2024 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f3b9f2e2-66c0-4310-9b8e-734781d2ed0a/download/hb_pitc2024_07_12-1.csv") %>% 
clean_names()

# Combine datasets
board <- bind_rows(jan_jun_2024, jul_dec_2024, jan_jun_2025, jul_aug_2025)

# Clean and remove duplicate-named columns 
board <- board %>% janitor::clean_names()
if (any(duplicated(names(board)))) {
  dup_names <- names(board)[duplicated(names(board))]
  message("Duplicate column names found and removed: ", paste(unique(dup_names), collapse = ", "))
  board <- board[, !duplicated(names(board))]
}

# Find columns on cleaned dataframe
find_col <- function(df, patterns){
  pat <- paste(patterns, collapse="|")
  cols <- names(df)[str_detect(names(df), regex(pat, ignore_case = TRUE))]
  if(length(cols)==0) return(NA_character_)
  cols[1]
}

# Identify the actual columns on the cleaned dataframe
col_paid_month <- find_col(board, c("^paid.?date.?month$","^paid_date_month$","paid.*month","paidmonth"))
col_hbt        <- find_col(board, c("^hbt$","^hb$","^health.*board","board"))
col_bnf_desc   <- find_col(board, c("bnf","item_description","bnf_item_description","description"))
col_num_items  <- find_col(board, c("number_of_paid_items","paid_items","no_of_paid_items","numberpaiditems","number_of_items"))
col_paid_qty   <- find_col(board, c("paid_quantity","paid_qty","quantity"))
col_gic        <- find_col(board, c("gross_ingredient_cost","gic","gross_ingredient"))

# Fail early if anything missing (gives readable error)
required <- c(col_paid_month, col_hbt, col_bnf_desc, col_num_items, col_paid_qty, col_gic)
if (any(is.na(required))) {
  stop("One or more required columns not found on cleaned data. Found:\n",
       paste0("paid_month=", col_paid_month, ", hbt=", col_hbt, ", bnf_desc=", col_bnf_desc,
              ", num_items=", col_num_items, ", paid_qty=", col_paid_qty, ", gic=", col_gic))
}

# Clean duplicate column names 
if (any(duplicated(names(board)))) {
  dup_cols <- names(board)[duplicated(names(board))]
  message("Removing duplicate columns: ", paste(dup_cols, collapse = ", "))
  board <- board[, !duplicated(names(board))]
}

# Remove duplicate columns before renaming
if (any(duplicated(names(board)))) {
  dup_cols <- names(board)[duplicated(names(board))]
  message("Removing duplicate columns: ", paste(dup_cols, collapse = ", "))
  board <- board[, !duplicated(names(board))]
}

# Rename to standard names safely

board <- board %>%
  rename(
    paid_date_month = all_of(col_paid_month),
    hbt = all_of(col_hbt),
    number_of_paid_items = all_of(col_num_items),
    paid_quantity = all_of(col_paid_qty),
    gross_ingredient_cost = all_of(col_gic)
  )

# Create date column from paid_date_month 
board <- board %>%
  mutate(
    paid_date_month = suppressWarnings(as.integer(paid_date_month)),
    year = paid_date_month %/% 100,
    month = paid_date_month %% 100,
    date = make_date(year, month, 1)
  ) %>%
  filter(!is.na(date))
  

# Filter rows that look like antihistamines
antikeys <- c("loratadine","cetirizine","chlorphenamine","fexofenadine",
              "promethazine","azelastine","levocetirizine","antihist")

board <- board %>%
  mutate(bnf_low = tolower(as.character(bnf_item_description))) %>%
  filter(str_detect(bnf_low, paste(antikeys, collapse = "|")))

# Check
glimpse(board)

```


```{r monthly_aggregate}
#Group variables
board_monthly <- board %>%
  group_by(hbt, date) %>%
  summarise(
    total_items = sum(number_of_paid_items, na.rm = TRUE),
    total_qty = sum(paid_quantity, na.rm = TRUE),
    total_cost = sum(gross_ingredient_cost, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(hbt, date)

# Check
glimpse(board_monthly)
```



```{r summary_table}
# Summary table by Health Board
summary_table <- board_monthly %>%
  group_by(hbt) %>%
  summarise(
    mean_monthly_items = mean(total_items, na.rm = TRUE),
    sd_monthly_items = sd(total_items, na.rm = TRUE),
    peak_month = date[which.max(total_items)],
    total_items_all = sum(total_items, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_monthly_items))

kable(summary_table, digits = 2, caption = "Antihistamine Prescribing Summary by Health Board")

# Save to csv
write.csv(summary_table, "summary_table_by_HBT.csv", row.names = FALSE)

```




```{r plot_faceted, fig.width=12, fig.height=9}
# Faceted time-series plot 

p <- ggplot(board_monthly, aes(x = date, y = total_items)) +
  geom_line() +
  facet_wrap(~ hbt, scales = "free_y", ncol = 3) +
  labs(
    title = "Monthly Antihistamine Prescribing by Health Board",
    subtitle = "Items dispensed per month",
    x = "Month",
    y = "Number of Items"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 9))

print(p)

# Save to csv
ggsave("antihistamine_by_HBT_faceted.png", p, width = 12, height = 9, dpi = 300)

```
Interpretation

All boards exhibit clear seasonal increase in antihistamine prescribing during late spring and summer, consistent with pollen allergy patterns. The magnitude of prescribing varies substantially across Health Boards. Larger Boards such as S08000031 and S08000032 show the highest mean monthly volumes.

Conclusion

There is strong evidence of seasonal variation in antihistamine prescribing across Scotland, with consistent peaks in early summer. Differences between Boards suggest varying population size, disease burden, and prescribing practice.

